name: Release

on:
  push:
    tags:
      - "[0-9]+.[0-9]+.[0-9]+"

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    name: Build (${{ matrix.target }})
    strategy:
      matrix:
        target:
          - x86_64-unknown-linux-gnu
          - aarch64-unknown-linux-gnu
          - aarch64-apple-darwin
        include:
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
          - target: aarch64-unknown-linux-gnu
            os: ubuntu-latest
          - target: aarch64-apple-darwin
            os: macos-latest
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libasound2-dev pkg-config libpipewire-0.3-dev libspa-0.2-dev

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Setup cross-compilation (Linux ARM64)
        if: matrix.target == 'aarch64-unknown-linux-gnu'
        run: |
          sudo mv /etc/apt/sources.list.d /etc/apt/sources.list.d.bak
          sudo mkdir -p /etc/apt/sources.list.d

          sudo cp /etc/apt/sources.list.d.bak/microsoft*.list /etc/apt/sources.list.d/ 2>/dev/null || true

          sudo tee /etc/apt/sources.list > /dev/null <<EOF
          # AMD64 repositories
          deb [arch=amd64] http://azure.archive.ubuntu.com/ubuntu/ noble main restricted universe multiverse
          deb [arch=amd64] http://azure.archive.ubuntu.com/ubuntu/ noble-updates main restricted universe multiverse
          deb [arch=amd64] http://azure.archive.ubuntu.com/ubuntu/ noble-security main restricted universe multiverse

          # ARM64 repositories
          deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports/ noble main restricted universe multiverse
          deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports/ noble-updates main restricted universe multiverse
          deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports/ noble-security main restricted universe multiverse
          EOF

          sudo dpkg --add-architecture arm64
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu
          sudo apt-get install -y libpipewire-0.3-dev:arm64 libspa-0.2-dev:arm64 libasound2-dev:arm64

          {
            echo "CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER=aarch64-linux-gnu-gcc"
            echo "PKG_CONFIG_ALLOW_CROSS=1"
            echo "PKG_CONFIG_PATH=/usr/lib/aarch64-linux-gnu/pkgconfig"
          } >> "$GITHUB_ENV"

      - name: Setup Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          key: release-${{ matrix.target }}

      - name: Build release
        run: cargo build --release --target ${{ matrix.target }}

      - name: Package binary
        shell: bash
        run: |
          cd target/${{ matrix.target }}/release
          tar czf ../../../rmpd-${{ github.ref_name }}-${{ matrix.target }}.tar.gz rmpd
          cd ../../..

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: rmpd-${{ matrix.target }}
          path: rmpd-${{ github.ref_name }}-${{ matrix.target }}.tar.gz

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: Generate changelog
        id: changelog
        run: |
          PREVIOUS_TAG=$(git tag --sort=-creatordate | sed -n '2p')
          if [ -n "$PREVIOUS_TAG" ]; then
            echo "Generating changelog from $PREVIOUS_TAG to ${{ github.ref_name }}"
            {
              echo 'CHANGELOG<<EOF'
              git log "${PREVIOUS_TAG}..${{ github.ref_name }}" --pretty=format:"- %s (%h)" --no-merges
              echo ''
              echo 'EOF'
            } >> "$GITHUB_OUTPUT"
          else
            echo "Generating changelog for first release"
            {
              echo 'CHANGELOG<<EOF'
              git log --pretty=format:"- %s (%h)" --no-merges
              echo ''
              echo 'EOF'
            } >> "$GITHUB_OUTPUT"
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: rmpd ${{ github.ref_name }}
          body: |
            ## What's Changed

            ${{ steps.changelog.outputs.CHANGELOG }}

            ## Downloads

            | Platform | Architecture | File |
            |----------|-------------|------|
            | Linux | x86_64 | `rmpd-${{ github.ref_name }}-x86_64-unknown-linux-gnu.tar.gz` |
            | Linux | aarch64 | `rmpd-${{ github.ref_name }}-aarch64-unknown-linux-gnu.tar.gz` |
            | macOS | aarch64 | `rmpd-${{ github.ref_name }}-aarch64-apple-darwin.tar.gz` |
          files: artifacts/*.tar.gz
          generate_release_notes: false
